service: hello-world-lambda

# ==========================================
# ğŸ“Œ ë¡œì»¬/ë°°í¬ í…ŒìŠ¤íŠ¸ ì „ëµ
# ==========================================
# ë¡œì»¬: serverless-offline + AWS DynamoDB ê°œë°œ í…Œì´ë¸”
# ë°°í¬: AWS Lambda + AWS DynamoDB í”„ë¡œë•ì…˜ í…Œì´ë¸”
#
# LocalStack/SAM CLI ì—†ëŠ” ì´ìœ :
# - LocalStack: ì„¤ì¹˜ ë³µì¡, í•™ìŠµìš©ìœ¼ë¡œ ì˜¤ë²„ìŠ¤íŒ©
# - SAM CLI: ë³„ë„ í…œí”Œë¦¿ í•„ìš”
# - í˜„ì¬ ë°©ì‹: ê°€ì¥ ê°„ë‹¨í•˜ê³  AWSì™€ ë™ì¼í•œ í™˜ê²½
# ==========================================

plugins:
  - serverless-offline # HTTP ì—”ë“œí¬ì¸íŠ¸ ë¡œì»¬ ì‹œë®¬ë ˆì´ì…˜

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}

  # ëª¨ë“  Lambda í•¨ìˆ˜ê°€ ê³µìœ í•  ê¶Œí•œ
  iam:
    role:
      name: HelloWorldRole-${self:provider.stage}
      statements:
        # CloudWatch Logs (ê¸°ë³¸ í•„ìˆ˜)
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"
        # DynamoDB ê¶Œí•œ
        - Effect: Allow
          Action:
            - dynamodb:GetItem
            - dynamodb:PutItem
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
            - dynamodb:Scan
          Resource: "arn:aws:dynamodb:${self:provider.region}:*:table/hello-world-items-${self:provider.stage}"

  # ëª¨ë“  Lambda í•¨ìˆ˜ê°€ ì ‘ê·¼í•  í™˜ê²½ë³€ìˆ˜
  environment:
    STAGE: ${self:provider.stage}
    LOG_LEVEL: INFO
    SERVICE_NAME: hello-world-lambda
    ITEMS_TABLE: hello-world-items-${self:provider.stage}

  # íƒœê·¸ (ëª¨ë“  ë¦¬ì†ŒìŠ¤ì— ìë™ ì¶”ê°€)
  tags:
    Environment: ${self:provider.stage}
    Service: HelloWorld
    Owner: Jason

# Lambda í•¨ìˆ˜ë“¤
functions:
  # 1ï¸âƒ£ ê°€ì¥ ê¸°ë³¸: íŒŒë¼ë¯¸í„° ì—†ì´ "Hello" ë°˜í™˜
  sayHello:
    handler: handlers/hello.helloHandler
    description: Simplest Lambda - returns Hello
    events:
      - http:
          path: hello
          method: get
          cors: true

  # 2ï¸âƒ£ ê²½ë¡œ íŒŒë¼ë¯¸í„° ë°›ê¸°: GET /hello/{name}
  greet:
    handler: handlers/hello.greetHandler
    description: Returns greeting with name parameter
    events:
      - http:
          path: hello/{name}
          method: get
          cors: true
          request:
            parameters:
              paths:
                name: true

  # 3ï¸âƒ£ POST ë³¸ë¬¸ ì²˜ë¦¬
  createMessage:
    handler: handlers/hello.createMessageHandler
    description: Creates a message from POST body
    events:
      - http:
          path: message
          method: post
          cors: true

  # 4ï¸âƒ£ ì—ëŸ¬ ì²˜ë¦¬ ì˜ˆì œ
  divide:
    handler: handlers/hello.divideHandler
    description: Divides two numbers (error handling demo)
    events:
      - http:
          path: divide/{a}/{b}
          method: get
          cors: true
          request:
            parameters:
              paths:
                a: true
                b: true

  # 5ï¸âƒ£ PUT ë©”ì„œë“œ: ì•„ì´í…œ ìˆ˜ì •
  updateItem:
    handler: handlers/hello.updateItemHandler
    description: Updates an item (PUT method demo)
    events:
      - http:
          path: item/{id}
          method: put
          cors: true
          request:
            parameters:
              paths:
                id: true

  # 6ï¸âƒ£ DELETE ë©”ì„œë“œ: ì•„ì´í…œ ì‚­ì œ
  deleteItem:
    handler: handlers/hello.deleteItemHandler
    description: Deletes an item (DELETE method demo)
    events:
      - http:
          path: item/{id}
          method: delete
          cors: true
          request:
            parameters:
              paths:
                id: true

  # 7ï¸âƒ£ GET /items - ëª¨ë“  ì•„ì´í…œ ì¡°íšŒ (DynamoDB Scan)
  listItems:
    handler: handlers/hello.listItemsHandler
    description: Lists all items from DynamoDB
    events:
      - http:
          path: items
          method: get
          cors: true

  # 8ï¸âƒ£ POST /item - ìƒˆ ì•„ì´í…œ ìƒì„± (DynamoDB Put)
  createItem:
    handler: handlers/hello.createItemHandler
    description: Creates a new item in DynamoDB
    events:
      - http:
          path: item
          method: post
          cors: true

# CloudFormation ë¦¬ì†ŒìŠ¤: DynamoDB í…Œì´ë¸”
resources:
  Resources:
    # hello-world-items í…Œì´ë¸”
    ItemsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: hello-world-items-${self:provider.stage}
        BillingMode: PAY_PER_REQUEST
        AttributeDefinitions:
          - AttributeName: id
            AttributeType: S
        KeySchema:
          - AttributeName: id
            KeyType: HASH
        StreamSpecification:
          StreamViewType: NEW_AND_OLD_IMAGES
        Tags:
          - Key: Environment
            Value: ${self:provider.stage}
          - Key: Service
            Value: HelloWorld

# ì»¤ìŠ¤í…€ ì„¤ì • (ì„ íƒ)
custom:
  # serverless-offline í”ŒëŸ¬ê·¸ì¸ ì„¤ì •
  serverless-offline:
    httpPort: 3000
    websocketPort: 3001
    lambdaPort: 3002
