service: api-s3-integration

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}

  # ğŸ”´ S3 ì ‘ê·¼ ê¶Œí•œ ì¶”ê°€
  iam:
    role:
      name: ApiS3Role-${self:provider.stage}
      statements:
        # CloudWatch Logs (í•„ìˆ˜)
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

        # ğŸŸ¢ S3 ë²„í‚· ëª©ë¡ ì¡°íšŒ ê¶Œí•œ
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource: "arn:aws:s3:::api-s3-bucket-${self:service}-${self:provider.stage}"

        # ğŸŸ¢ S3 ê°ì²´ ì½ê¸°/ì“°ê¸° ê¶Œí•œ
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource: "arn:aws:s3:::api-s3-bucket-${self:service}-${self:provider.stage}/*"

  environment:
    STAGE: ${self:provider.stage}
    BUCKET_NAME: api-s3-bucket-${self:service}-${self:provider.stage}
    BUCKET_REGION: ${self:provider.region}

functions:
  # API Gateway + S3 í†µí•© í•¸ë“¤ëŸ¬ë“¤
  listFiles:
    handler: handlers/s3.listFilesHandler
    description: List all files in S3 bucket
    memorySize: ${self:custom.stageConfig.memorySize}
    timeout: ${self:custom.stageConfig.timeout}
    events:
      - http:
          path: files
          method: get
          cors: true

  uploadFile:
    handler: handlers/s3.uploadFileHandler
    description: Generate pre-signed URL for uploading
    memorySize: ${self:custom.stageConfig.memorySize}
    timeout: ${self:custom.stageConfig.timeout}
    events:
      - http:
          path: files/upload
          method: post
          cors: true

  getFile:
    handler: handlers/s3.getFileHandler
    description: Generate pre-signed URL for downloading
    memorySize: ${self:custom.stageConfig.memorySize}
    timeout: ${self:custom.stageConfig.timeout}
    events:
      - http:
          path: files/{filename}
          method: get
          cors: true

  deleteFile:
    handler: handlers/s3.deleteFileHandler
    description: Delete file from S3
    memorySize: ${self:custom.stageConfig.memorySize}
    timeout: ${self:custom.stageConfig.timeout}
    events:
      - http:
          path: files/{filename}
          method: delete
          cors: true

  # ğŸŸ¡ S3 ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°: íŒŒì¼ ì—…ë¡œë“œ ê°ì§€
  processUpload:
    handler: handlers/s3.processUploadHandler
    description: Triggered when file is uploaded to S3
    memorySize: ${self:custom.stageConfig.memorySize}
    timeout: ${self:custom.stageConfig.timeout}
    events:
      # S3 ì—ì„œ íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ê°ì§€
      - s3:
          bucket: !Ref UploadBucket
          event: s3:ObjectCreated:*
          rules:
            # uploads/ í´ë” ì•„ë˜ë§Œ
            - prefix: uploads/
            # .json íŒŒì¼ë§Œ
            - suffix: .json
          existing: true
    # ì´ í•¨ìˆ˜ëŠ” API Gateway íŠ¸ë¦¬ê±° ì—†ìŒ (S3 ì´ë²¤íŠ¸ë§Œ)

  # ğŸŸ¡ S3 ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°: íŒŒì¼ ì‚­ì œ ê°ì§€
  processDelete:
    handler: handlers/s3.processDeleteHandler
    description: Triggered when file is deleted from S3
    memorySize: ${self:custom.stageConfig.memorySize}
    timeout: ${self:custom.stageConfig.timeout}
    events:
      # S3 ì—ì„œ íŒŒì¼ ì‚­ì œ ì´ë²¤íŠ¸ ê°ì§€
      - s3:
          bucket: !Ref UploadBucket
          event: s3:ObjectRemoved:*
          rules:
            # uploads/ í´ë” ì•„ë˜ë§Œ
            - prefix: uploads/
          existing: true

# ğŸ”´ ì¶”ê°€ AWS ë¦¬ì†ŒìŠ¤ ì •ì˜
resources:
  Resources:
    # S3 ë²„í‚· ìƒì„±
    UploadBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.s3Bucket.name}
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            # Stageë³„ ë‹¤ë¥¸ ë³´ê´€ ê¸°ê°„ ì ìš© (ë¹„ìš© ì ˆê°)
            - Id: DeleteOldVersions
              NoncurrentVersionExpirationInDays: ${self:custom.s3Bucket.currentLifecycleDays}
              Status: Enabled

plugins:
  - serverless-offline
  - serverless-s3-local

custom:
  # ============================================
  # 1ï¸âƒ£ ê¸°ë³¸ ì„¤ì •
  # ============================================
  timestamp: ${file(./timestamp.js):timestamp}

  # ============================================
  # 2ï¸âƒ£ Stageë³„ í™˜ê²½ ì„¤ì • (dev, staging, prod)
  # ============================================
  stages:
    dev:
      memorySize: 256 # ê°œë°œ: ì €ë©”ëª¨ë¦¬
      timeout: 30
      logRetentionInDays: 3 # ë¡œê·¸ 3ì¼ ë³´ê´€
      enableXRay: false

    staging:
      memorySize: 512 # ìŠ¤í…Œì´ì§•: ì¤‘ê°„
      timeout: 60
      logRetentionInDays: 7
      enableXRay: true

    prod:
      memorySize: 1024 # í”„ë¡œë•ì…˜: ê³ ë©”ëª¨ë¦¬
      timeout: 120
      logRetentionInDays: 30
      enableXRay: true

  # í˜„ì¬ stageì˜ ì„¤ì • ì„ íƒ
  currentStage: ${self:provider.stage}
  stageConfig: ${self:custom.stages.${self:custom.currentStage}}

  # ============================================
  # 3ï¸âƒ£ ë¡œì»¬ S3 ì—ë®¬ë ˆì´í„° ì„¤ì •
  # ============================================
  s3:
    host: 127.0.0.1
    directory: ./.s3
    port: 9000

  # ============================================
  # 4ï¸âƒ£ API ì„¤ì • (í”„ë¡ íŠ¸ì—”ë“œìš©)
  # ============================================
  api:
    name: ${self:service}-${self:provider.stage}
    corsOrigins:
      dev: "http://localhost:3000"
      staging: "https://staging.example.com"
      prod: "https://example.com"
    currentCorsOrigin: ${self:custom.api.corsOrigins.${self:custom.currentStage}}

  # ============================================
  # 5ï¸âƒ£ S3 ë²„í‚· ì„¤ì •
  # ============================================
  s3Bucket:
    name: api-s3-bucket-${self:service}-${self:provider.stage}
    # íŒŒì¼ ë³´ê´€ ê¸°ê°„ (stageë³„ ë‹¤ë¦„)
    lifecycleDays:
      dev: 7 # ê°œë°œ: 7ì¼
      staging: 15 # ìŠ¤í…Œì´ì§•: 15ì¼
      prod: 90 # í”„ë¡œë•ì…˜: 90ì¼
    currentLifecycleDays: ${self:custom.s3Bucket.lifecycleDays.${self:provider.stage}}
