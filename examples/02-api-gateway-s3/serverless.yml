service: api-s3-integration

provider:
  name: aws
  runtime: nodejs18.x
  region: us-east-1
  stage: ${opt:stage, 'dev'}

  # ğŸ”´ S3 ì ‘ê·¼ ê¶Œí•œ ì¶”ê°€
  iam:
    role:
      name: ApiS3Role-${self:provider.stage}
      statements:
        # CloudWatch Logs (í•„ìˆ˜)
        - Effect: Allow
          Action:
            - logs:CreateLogGroup
            - logs:CreateLogStream
            - logs:PutLogEvents
          Resource: "*"

        # ğŸŸ¢ S3 ë²„í‚· ëª©ë¡ ì¡°íšŒ ê¶Œí•œ
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource: "arn:aws:s3:::api-s3-bucket-${self:service}-${self:provider.stage}"

        # ğŸŸ¢ S3 ê°ì²´ ì½ê¸°/ì“°ê¸° ê¶Œí•œ
        - Effect: Allow
          Action:
            - s3:GetObject
            - s3:PutObject
            - s3:DeleteObject
          Resource: "arn:aws:s3:::api-s3-bucket-${self:service}-${self:provider.stage}/*"

  environment:
    STAGE: ${self:provider.stage}
    BUCKET_NAME: api-s3-bucket-${self:service}-${self:provider.stage}
    BUCKET_REGION: ${self:provider.region}

functions:
  # API Gateway + S3 í†µí•© í•¸ë“¤ëŸ¬ë“¤
  listFiles:
    handler: handlers/s3.listFilesHandler
    description: List all files in S3 bucket
    events:
      - http:
          path: files
          method: get
          cors: true

  uploadFile:
    handler: handlers/s3.uploadFileHandler
    description: Generate pre-signed URL for uploading
    events:
      - http:
          path: files/upload
          method: post
          cors: true

  getFile:
    handler: handlers/s3.getFileHandler
    description: Generate pre-signed URL for downloading
    events:
      - http:
          path: files/{filename}
          method: get
          cors: true

  deleteFile:
    handler: handlers/s3.deleteFileHandler
    description: Delete file from S3
    events:
      - http:
          path: files/{filename}
          method: delete
          cors: true

  # ğŸŸ¡ S3 ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°: íŒŒì¼ ì—…ë¡œë“œ ê°ì§€
  processUpload:
    handler: handlers/s3.processUploadHandler
    description: Triggered when file is uploaded to S3
    events:
      # S3 ì—ì„œ íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸ ê°ì§€
      - s3:
          bucket: !Ref UploadBucket
          event: s3:ObjectCreated:*
          rules:
            # uploads/ í´ë” ì•„ë˜ë§Œ
            - prefix: uploads/
            # .json íŒŒì¼ë§Œ
            - suffix: .json
          existing: true
    # ì´ í•¨ìˆ˜ëŠ” API Gateway íŠ¸ë¦¬ê±° ì—†ìŒ (S3 ì´ë²¤íŠ¸ë§Œ)

  # ğŸŸ¡ S3 ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°: íŒŒì¼ ì‚­ì œ ê°ì§€
  processDelete:
    handler: handlers/s3.processDeleteHandler
    description: Triggered when file is deleted from S3
    events:
      # S3 ì—ì„œ íŒŒì¼ ì‚­ì œ ì´ë²¤íŠ¸ ê°ì§€
      - s3:
          bucket: !Ref UploadBucket
          event: s3:ObjectRemoved:*
          rules:
            # uploads/ í´ë” ì•„ë˜ë§Œ
            - prefix: uploads/
          existing: true

# ğŸ”´ ì¶”ê°€ AWS ë¦¬ì†ŒìŠ¤ ì •ì˜
resources:
  Resources:
    # S3 ë²„í‚· ìƒì„±
    UploadBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: api-s3-bucket-${self:service}-${self:provider.stage}
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            # 30ì¼ í›„ ì´ì „ ë²„ì „ ì‚­ì œ (ë¹„ìš© ì ˆê°)
            - Id: DeleteOldVersions
              NoncurrentVersionExpirationInDays: 30
              Status: Enabled

plugins:
  - serverless-offline
  - serverless-s3-local

custom:
  timestamp: ${file(./timestamp.js):timestamp}
  s3:
    # ë¡œì»¬ S3 ì—ë®¬ë ˆì´í„° ì„¤ì •
    host: 127.0.0.1
    directory: ./.s3
    port: 9000
